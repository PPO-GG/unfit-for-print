# ─────────────────────────────────────────────────────────────────────────────
# Unfit for Print — Release & Deploy
#
# Triggered on every push to main:
#   1. release-please evaluates new commits and opens/updates a Release PR
#   2. When the Release PR is merged, a GitHub Release + tag are created,
#      then the app is built and deployed to Cloudflare Workers
#
# This ensures only ONE production build per release cycle, no redundant
# builds on regular pushes to main or on release-please's own PR branch.
#
# Prerequisites (GitHub repo settings):
#   Secrets  → CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID
#   Secrets  → ELEVENLABS_API_KEY, NUXT_PUBLIC_BASE_URL
#   Variables→ All NUXT_PUBLIC_APPWRITE_* values (non-sensitive, shared across envs)
#
# Prerequisites (Cloudflare dashboard):
#   Disable automatic git-triggered builds (set production branch to
#   an unused branch like _no-auto-build, or disconnect Git integration)
# ─────────────────────────────────────────────────────────────────────────────

name: Release & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deploy without a release (for debugging)"
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  # ── Step 1: Release Please ──────────────────────────────────────────────
  # On regular pushes: creates or updates the Release PR (no deploy).
  # On Release PR merge: creates a GitHub Release + tag, then signals deploy.
  release-please:
    name: Release Please
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ── Step 2: Build & Deploy (only on new release OR manual dispatch) ───
  deploy:
    name: Deploy to Cloudflare Workers
    needs: release-please
    if: ${{ always() && (needs.release-please.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch') }}
    runs-on: ubuntu-latest
    environment: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for Cloudflare Workers
        run: pnpm run build
        env:
          NITRO_PRESET: cloudflare-module
          # ── Public runtime config (baked into client bundle) ────────────
          NUXT_PUBLIC_APPWRITE_ENDPOINT: ${{ vars.NUXT_PUBLIC_APPWRITE_ENDPOINT }}
          NUXT_PUBLIC_APPWRITE_PROJECT_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_PROJECT_ID }}
          NUXT_PUBLIC_APPWRITE_DATABASE_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_DATABASE_ID }}
          NUXT_PUBLIC_APPWRITE_WHITE_CARD_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_WHITE_CARD_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_BLACK_CARD_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_BLACK_CARD_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_LOBBY_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_LOBBY_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_PLAYER_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_PLAYER_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_GAMECARDS_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_GAMECARDS_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_GAMECHAT_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_GAMECHAT_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_GAMESETTINGS_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_GAMESETTINGS_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_SUBMISSION_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_SUBMISSION_COLLECTION_ID }}
          NUXT_PUBLIC_APPWRITE_REPORTS_COLLECTION_ID: ${{ vars.NUXT_PUBLIC_APPWRITE_REPORTS_COLLECTION_ID }}
          NUXT_PUBLIC_BASE_URL: ${{ secrets.NUXT_PUBLIC_BASE_URL }}
          # ── Server-only secrets (available at runtime via CF env vars) ──
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --keep-vars
